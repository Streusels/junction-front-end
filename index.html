<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8' />
    <title>HexRank</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.42.2/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.42.2/mapbox-gl.css' rel='stylesheet' />
    <script src='https://npmcdn.com/@turf/turf/turf.min.js'></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #map {
            position: absolute;
            top: 4vh;
            bottom: 0;
            width: 100%;
        }
    </style>
</head>

<body>

    <div id='map'></div>
    <script>
        mapboxgl.accessToken = 'pk.eyJ1IjoibmxhbWJlMiIsImEiOiJjazVubXJyM3IweDRwM25wNndlbWhjc3U5In0.4y-pp1CsRG42pY_h5xTdcA';
        var startingPoint = [24.9456, 60.16776];

        var map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v9',
            center: startingPoint,
            zoom: 10,
            pitch: 60
        });
        const scale = 200;

        var hexagon_collection = { type: "FeatureCollection", features: [] }
        $.getJSON("./helsinki_hexagons.json", function (data) {

            // get k-sized feature vectors for all hexagons
            const num_features = 8;
            const scale = 40;

            const min_top_layer = [225, 203, 255]
            const max_top_layer = [52, 0, 124]

            const colors = ['#fbb4ae', '#b3cde3', '#ccebc5 ', '#decbe4', '#fed9a6', '#fff2ae', '#e5d8bd', '#d9d9d9']

            var features = {sums: [], stats: []}

            for (let i = 0; i < data['features'].length; i++) {
                let vec = []
                for (let k = 0; k < num_features; k++) {
                    vec.push(scale * Math.random() + 1)
                }
                features.stats.push(vec)
                features.sums.push(vec.reduce((a, b) => a + b, 0))
            }

            const max_sum = Math.max(...features.sums)
            const min_sum = Math.min(...features.sums)
            console.log(max_sum, min_sum)

            console.log(features)

            for (let hexagon in data['features']) {
                // console.log(data['features'][hexagon])
                //data['features'][hexagon]['geometry']['coordinates'] = data['features'][hexagon]['geometry']['coordinates'][0]
                
                
                // all poped out
                /*
                let cur_height = 0;
                for (let i = 0; i < num_features; i++) {

                    hexagon_collection['features'].push({
                        type: "Feature",
                        properties: {
                            color: colors[i],
                            base_height: cur_height,
                            top_height: cur_height + features.stats[hexagon][i],
                            opacity: features.sums[hexagon]/(scale*num_features)
                        },
                        geometry: data['features'][hexagon].geometry
                    })
                    cur_height += features.stats[hexagon][i]
                }
                */

                // initial top layer
                let col = (features.sums[hexagon] - min_sum)/max_sum;
                hexagon_collection['features'].push({
                        type: "Feature",
                        properties: {
                            color: `rgb(${Math.floor(col*max_top_layer[0] + (1-col)*min_top_layer[0])},
                                        ${Math.floor(col*max_top_layer[1] + (1-col)*min_top_layer[1])},
                                        ${Math.floor(col*max_top_layer[2] + (1-col)*min_top_layer[2])})`,
                            base_height: 0,
                            top_height: 5,
                        },
                        geometry: data['features'][hexagon].geometry
                    })

            }

            console.log('Hexa', hexagon_collection);

            map.on('load', function () {

                map.addSource('hexagon', {
                    type: 'geojson',
                    data: hexagon_collection
                });

                map.addLayer({
                    id: 'hexagon',
                    type: 'fill-extrusion',
                    source: 'hexagon',
                    layout: {},
                    paint: {
                        'fill-extrusion-color': {
                            type: 'identity',
                            property: 'color'
                        },
                        'fill-extrusion-base': {
                            type: 'identity',
                            property: 'base_height'
                        },
                        'fill-extrusion-height': {
                            type: 'identity',
                            property: 'top_height'
                        },
                        'fill-extrusion-opacity': 0.8
                    }
                });
            });
        });


    </script>

</body>

</html>