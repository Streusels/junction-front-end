<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8' />
    <title>HexRank</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.42.2/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.42.2/mapbox-gl.css' rel='stylesheet' />
    <script src='https://npmcdn.com/@turf/turf/turf.min.js'></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #map {
            position: absolute;
            top: 4vh;
            bottom: 0;
            width: 100%;
        }
    </style>
</head>

<body>

    <div id='map'></div>
    <script>
        mapboxgl.accessToken = 'pk.eyJ1IjoibmxhbWJlMiIsImEiOiJjazVubXJyM3IweDRwM25wNndlbWhjc3U5In0.4y-pp1CsRG42pY_h5xTdcA';
        var startingPoint = [24.9456, 60.16776];

        var map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v9',
            center: startingPoint,
            zoom: 10,
            pitch: 60
        });
        const scale = 200;

        var base_hexagons = { type: "FeatureCollection", features: [] }
        var stack_hexagons = { type: "FeatureCollection", features: [] }

        $.getJSON("./helsinki_hexagons.json", function (data) {

            // get k-sized feature vectors for all hexagons
            const num_features = 8;
            const scale = 500;
            const base_height = 20;
            

            const min_top_layer = [225, 203, 255]
            const max_top_layer = [52, 0, 124]

            const colors = ['#fbb4ae', '#b3cde3', '#ccebc5 ', '#decbe4', '#fed9a6', '#ffffcc', '#e5d8bd', '#fddaec']

            var features = { sums: [], stats: [] }

            for (let i = 0; i < data['features'].length; i++) {
                let vec = []
                for (let k = 0; k < num_features; k++) {
                    vec.push(scale * Math.random() + 1)
                }
                features.stats.push(vec)
                features.sums.push(vec.reduce((a, b) => a + b, 0))
            }

            const max_sum = Math.max(...features.sums)
            const min_sum = Math.min(...features.sums)
            console.log(max_sum, min_sum)

            console.log(features)

            for (let hexagon in data['features']) {
                // console.log(data['features'][hexagon])
                //data['features'][hexagon]['geometry']['coordinates'] = data['features'][hexagon]['geometry']['coordinates'][0]


                // all poped out

                let cur_height = 0;
                for (let i = 0; i < num_features; i++) {

                    stack_hexagons['features'].push({
                        type: "Feature",
                        properties: {
                            color: colors[i],
                            base_height: cur_height,
                            top_height: cur_height + features.stats[hexagon][i],
                            show: false,
                            id: parseInt(hexagon)
                        },
                        geometry: data['features'][hexagon].geometry
                    })
                    cur_height += features.stats[hexagon][i]
                }


                // initial top layer
                let col = (features.sums[hexagon] - min_sum) / max_sum;
                base_hexagons['features'].push({
                    type: "Feature",
                    properties: {
                        color: `rgb(${Math.floor(col * max_top_layer[0] + (1 - col) * min_top_layer[0])},
                                        ${Math.floor(col * max_top_layer[1] + (1 - col) * min_top_layer[1])},
                                        ${Math.floor(col * max_top_layer[2] + (1 - col) * min_top_layer[2])})`,
                        base_height: 0,
                        top_height: base_height,
                        show: true,
                        id: parseInt(hexagon),

                    },
                    geometry: data['features'][hexagon].geometry,
                    id: parseInt(hexagon)
                })

            }

            console.log('Hexa', base_hexagons);

            map.on('load', function () {

                map.addSource('base', {
                    type: 'geojson',
                    data: base_hexagons,
                });

                map.addSource('stacks', {
                    type: 'geojson',
                    data: stack_hexagons,
                });

                map.addLayer({
                    id: 'base-hexagons',
                    type: 'fill-extrusion',
                    source: 'base',
                    layout: {},
                    paint: {
                        'fill-extrusion-color': {
                            type: 'identity',
                            property: 'color'
                        },
                        'fill-extrusion-base': {
                            type: 'identity',
                            property: 'base_height'
                        },
                        'fill-extrusion-height': {
                            type: 'identity',
                            property: 'top_height'
                        },
                        'fill-extrusion-opacity': 0.6
                    },
                    filter: ['==', 'show', true]
                });

                map.addLayer({
                    id: 'stack-hexagons',
                    type: 'fill-extrusion',
                    source: 'stacks',
                    layout: {},
                    paint: {
                        'fill-extrusion-color': {
                            type: 'identity',
                            property: 'color'
                        },
                        'fill-extrusion-base': {
                            type: 'identity',
                            property: 'base_height'
                        },
                        'fill-extrusion-height': {
                            type: 'identity',
                            property: 'top_height'
                        },
                        'fill-extrusion-opacity': 0.95
                    },
                    filter: ['==', 'show', true]
                });

                map.on('mousemove', 'base-hexagons', (e) => {

                    map.getCanvas().style.cursor = 'pointer';

                    const feature = e.features[0];

                    console.log(feature)

                    //poped_out.add(feature.id)

                    map.setFilter('stack-hexagons', ['in', 'id', feature.id])
                    //map.setFilter('base-hexagons', ['!=', 'id', feature.id])
                    /*
                    if (e.features.length > 0) {
                        if (hoveredStateId !== null) {
                            map.setFeatureState(
                                { source: 'states', id: hoveredStateId },
                                { hover: false }
                            );
                        }
                        hoveredStateId = e.features[0].id;
                        map.setFeatureState(
                            { source: 'states', id: hoveredStateId },
                            { hover: true }
                        );
                    }
                    */
                });
            });
        });


    </script>

</body>

</html>